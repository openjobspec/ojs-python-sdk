name: API Compatibility

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  griffe:
    name: Python API Compatibility Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install griffe

      - name: Check for breaking changes
        run: |
          # Compare against the base branch
          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          git fetch origin "${{ github.event.pull_request.base.ref }}" --depth=1

          griffe check src/openjobspec --against "$BASE_REF" 2>&1 || {
            # griffe returns non-zero on breaking changes
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 1 ]; then
              echo "::error::Breaking API changes detected. If intentional, add 'breaking-change' label."
              exit 1
            fi
            echo "::notice::griffe check completed with warnings."
          }
